<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gondwana Rates API</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
     <!-- Navbar -->
<nav class="navbar">
  <div class="nav-container">
    <!-- Logo -->
    <a href="/" class="logo">
      <img src="https://cdn.brandfetch.io/idIGTw8iYF/w/252/h/64/theme/light/logo.png?c=1bxid64Mup7aczewSAYMX&t=1755114121246" alt="Gondwana Logo" height="50">
    </a>

    <!-- Hamburger button (visible on mobile) -->
    <button class="menu-toggle" aria-label="Toggle menu">
      â˜°
    </button>

    <!-- Navigation links -->
    <ul class="nav-links">
      <li><a href="/">Home</a></li>
      <li><a href="/index.html">Rates</a></li>
    </ul>
  </div>
</nav>


    <!-- Page content -->
    <div class="page-content">
        <div class="container">
            <h1>Get Gondwana Rates</h1>

            <!-- Rates form -->
            <form id="ratesForm">
                <label for="unitTypeId">Unit Type ID:</label>
                <input type="text" id="unitTypeId" name="unitTypeId" required>

                <label for="Arrival">Arrival:</label>
                <input type="date" id="Arrival" name="Arrival" required>

                <label for="Departure">Departure:</label>
                <input type="date" id="Departure" name="Departure" required>

                <label for="Occupants">Occupants:</label>
                <input type="number" id="Occupants" name="Occupants" required>

                <label for="Ages">Ages (comma-separated):</label>
                <input type="text" id="Ages" name="Ages" placeholder="e.g., 25,14" required>

                <button type="submit">Get Rates</button>
            </form>

            <!-- Table to show rates -->
            <h2>Rates:</h2>
            <table id="ratesTable">
                <thead>
                    <tr>
                        <th>Unit Type ID</th>
                        <th>Unit Name</th>
                        <th>Arrival</th>
                        <th>Departure</th>
                        <th>Guest</th>
                        <th>Rate</th>
                        <th>Avg Daily Rate</th>
                        <th>Rate Type</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <!-- Raw API response -->
            <div class="json-response-container">
                <h2>API Response JSON</h2>
                <pre id="response"></pre>
            </div>
        </div>
    </div>

    <script>
    // Handle form submit
    document.getElementById('ratesForm').addEventListener('submit', async function(e) {
        e.preventDefault(); // stop reload
        const form = e.target;

        // Split ages into adults and children
        const userAges = form.Ages.value.split(',').map(a => parseInt(a.trim()));
        const adultsInput = userAges.filter(a => a >= 18);
        const childrenInput = userAges.filter(a => a < 18);

        // Payload for API
        const payload = {
            "Unit Type ID": parseInt(form.unitTypeId.value),
            "Arrival": form.Arrival.value,
            "Departure": form.Departure.value,
            "Guests": userAges.map(a => ({
                "Age Group": a >= 18 ? "Adult" : "Child"
            }))
        };

        const tableBody = document.querySelector('#ratesTable tbody');
        tableBody.innerHTML = ''; // clear old data

        try {
            // Send request to backend
            const response = await fetch('/api/rates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Parse response (safe)
            const text = await response.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch {
                throw new Error('Invalid JSON response: ' + text);
            }

            // Show raw JSON
            document.getElementById('response').textContent = JSON.stringify(result, null, 2);

            // Populate table
            const legs = result.Legs || [];
            legs.forEach(leg => {
                (leg.Guests || []).forEach(guest => {
                    let age;
                    if (guest['Age Group'] === 'Adult') {
                        age = adultsInput.shift();
                    } else {
                        age = childrenInput.shift();
                    }
                    guest.Age = age;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${leg['Unit Type ID'] || payload['Unit Type ID']}</td>
                        <td>${leg['Special Rate Description'] || ''}</td>
                        <td>${payload.Arrival}</td>
                        <td>${payload.Departure}</td>
                        <td>${guest['Age Group']} (${guest.Age})</td>
                        <td>${leg['Total Charge'] || ''}</td>
                        <td>${leg['Effective Average Daily Rate'] || ''}</td>
                        <td>${leg['Category'] || ''}</td>
                    `;
                    tableBody.appendChild(row);
                });
            });

        } catch (err) {
            // Show error if API fails
            document.getElementById('response').textContent = 'Error fetching rates: ' + err.message;
        }
    });

    // Mobile menu toggle
    const menuToggle = document.querySelector(".menu-toggle");
    const navLinks = document.querySelector(".nav-links");

    menuToggle.addEventListener("click", () => {
        navLinks.classList.toggle("show"); // toggles visibility
    });
    </script>

    <!-- Footer -->
    <footer>
        <p>&copy; Gondwana API. All rights reserved.</p>
    </footer>
</body>
</html>
